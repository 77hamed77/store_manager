{% extends 'store/base.html' %}

{% block title %}نقطة البيع{% endblock %}

{% block extra_head %}
<style>
    /* لإخفاء أسهم حقل الرقم */
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type='number'] { -moz-appearance: textfield; }

    /* ستايل إشعارات الـ Toast */
    #toast-notification {
        position: fixed; bottom: 20px; left: 20px;
        transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        transform: translateY(150%); opacity: 0; z-index: 50;
    }
    #toast-notification.show { transform: translateY(0); opacity: 1; }

    /* ستايل زر طريقة الدفع النشط */
    .payment-btn.active {
        border-color: #4f46e5; /* indigo-600 */
        background-color: #e0e7ff; /* indigo-200 */
        box-shadow: 0 0 0 2px #c7d2fe; /* indigo-300 ring */
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

    <!-- 1. الجانب الأيسر: البحث والسلة -->
    <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
        <!-- بحث محسن للمنتجات -->
        <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
            <input type="text" id="product-search-input" class="w-full p-3 pl-10 border rounded-lg" placeholder="ابحث بالاسم أو الرمز لإضافة للسلة...">
            <div id="product-search-results" class="absolute z-20 w-full bg-white border mt-1 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
        </div>
        
        <!-- سلة مشتريات بتصميم البطاقات -->
        <h2 class="text-xl font-bold mt-8 mb-4">سلة المشتريات</h2>
        <div id="cart-items" class="flex-grow min-h-[200px] space-y-3">
            <div id="empty-cart-message" class="text-center pt-8 text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">السلة فارغة</h3>
                <p class="mt-1 text-sm text-gray-500">ابدأ بالبحث عن منتج لإضافته.</p>
            </div>
        </div>
    </div>

    <!-- 2. الجانب الأيمن: الدفع -->
    <div class="lg:col-span-2 h-fit sticky top-4">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="border-b pb-4 mb-4">
                <div class="flex justify-between items-center">
                    <span class="text-lg font-bold">الإجمالي:</span>
                    <span id="cart-total" class="text-3xl font-bold text-green-600 font-mono">0.00</span>
                </div>
            </div>

            <div id="payment-area" class="space-y-4">
                <div id="payment-method-selector">
                    <label class="block font-medium mb-2">اختر طريقة الدفع:</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="cash-sale-btn" class="payment-btn flex items-center justify-center gap-2 border-2 border-gray-200 hover:border-blue-500 p-3 rounded-lg font-bold transition-all">
                            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            <span>بيع نقدي</span>
                        </button>
                        <button id="credit-sale-btn" class="payment-btn flex items-center justify-center gap-2 border-2 border-gray-200 hover:border-orange-500 p-3 rounded-lg font-bold transition-all">
                            <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                            <span>بيع دين</span>
                        </button>
                    </div>
                </div>

                <div id="client-search-area" class="hidden space-y-2">
                    <div class="relative">
                        <input type="text" id="client-search-input" class="w-full p-2 border rounded-lg" placeholder="اكتب اسم العميل...">
                        <div id="client-search-results" class="absolute z-10 w-full bg-white border mt-1 rounded-lg shadow-lg max-h-40 overflow-y-auto"></div>
                    </div>
                    <div id="selected-client-display" class="hidden flex items-center gap-3 p-2 bg-blue-50 rounded-lg">
                        <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-blue-200 text-blue-700 rounded-full font-bold">ع</span>
                        <span id="selected-client-name" class="font-bold text-blue-700"></span>
                    </div>
                </div>

                <button id="complete-sale-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center transition-colors disabled:opacity-50" disabled>
                    <span class="btn-text">اختر طريقة دفع أولاً</span>
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden btn-spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="toast-notification" class="p-4 rounded-lg shadow-lg text-white max-w-sm"><p id="toast-message"></p></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    const POS_APP = {
        // --- 1. State ---
        cart: [],
        paymentMethod: null,
        selectedClient: null,
        apiInProcess: false,

        // --- 2. DOM Elements ---
        elements: {
            productSearchInput: document.getElementById('product-search-input'),
            productSearchResults: document.getElementById('product-search-results'),
            cartItemsDiv: document.getElementById('cart-items'),
            emptyCartMessage: document.getElementById('empty-cart-message'),
            cartTotalSpan: document.getElementById('cart-total'),
            cashBtn: document.getElementById('cash-sale-btn'),
            creditBtn: document.getElementById('credit-sale-btn'),
            completeSaleBtn: document.getElementById('complete-sale-btn'),
            clientSearchArea: document.getElementById('client-search-area'),
            clientSearchInput: document.getElementById('client-search-input'),
            clientSearchResults: document.getElementById('client-search-results'),
            selectedClientDisplay: document.getElementById('selected-client-display'),
            selectedClientName: document.getElementById('selected-client-name'),
            toast: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message'),
        },

        // --- 3. Initialization ---
        init() {
            this.addEventListeners();
            this.renderCart();
        },

        addEventListeners() {
            this.elements.productSearchInput.addEventListener('input', e => this.handleProductSearch(e));
            this.elements.productSearchResults.addEventListener('click', e => this.addProductToCart(e));
            this.elements.cartItemsDiv.addEventListener('click', e => this.handleCartClick(e));
            
            this.elements.cashBtn.addEventListener('click', () => this.setPaymentMethod('CASH'));
            this.elements.creditBtn.addEventListener('click', () => this.setPaymentMethod('CREDIT'));
            
            this.elements.clientSearchInput.addEventListener('input', e => this.handleClientSearch(e));
            this.elements.clientSearchResults.addEventListener('click', e => this.selectClient(e));

            this.elements.completeSaleBtn.addEventListener('click', () => this.submitSale());
        },

        // --- 4. Core Logic ---
        renderCart() {
            const { cartItemsDiv, cartTotalSpan, emptyCartMessage } = this.elements;
            cartItemsDiv.innerHTML = '';
            
            if (this.cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                cartItemsDiv.appendChild(emptyCartMessage);
                cartTotalSpan.textContent = '0.00';
            } else {
                emptyCartMessage.style.display = 'none';
                let total = 0;
                this.cart.forEach((item, index) => {
                    const itemTotal = parseFloat(item.price) * item.quantity;
                    total += itemTotal;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex items-center gap-4 p-3 border rounded-lg';
                    itemDiv.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-500">${parseFloat(item.price).toFixed(2)} x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-index="${index}" class="quantity-btn quantity-minus bg-gray-200 rounded-full w-7 h-7 flex items-center justify-center font-bold text-lg hover:bg-gray-300">-</button>
                            <span class="font-mono w-8 text-center">${item.quantity}</span>
                            <button data-index="${index}" class="quantity-btn quantity-plus bg-gray-200 rounded-full w-7 h-7 flex items-center justify-center font-bold text-lg hover:bg-gray-300">+</button>
                        </div>
                        <p class="font-bold font-mono w-20 text-right">${itemTotal.toFixed(2)}</p>
                        <button data-index="${index}" class="remove-item-btn text-red-400 hover:text-red-600">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    `;
                    cartItemsDiv.appendChild(itemDiv);
                });
                cartTotalSpan.textContent = total.toFixed(2);
            }
            this.updateSubmitButtonState();
        },
        
        async handleProductSearch(e) {
            const query = e.target.value;
            const { productSearchResults } = this.elements;
            if (query.length < 1) {
                productSearchResults.innerHTML = '';
                return;
            }

            const response = await fetch(`/api/search-products/?q=${encodeURIComponent(query)}`);
            const products = await response.json();
            productSearchResults.innerHTML = '';
            products.forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 hover:bg-gray-100 cursor-pointer border-b';
                div.innerHTML = `
                    <div>
                        <p class="font-semibold">${p.name}</p>
                        <p class="text-sm text-gray-500">المتوفر: ${p.stock}</p>
                    </div>
                    <span class="font-mono text-green-600">${parseFloat(p.price).toFixed(2)}</span>
                `;
                div.dataset.product = JSON.stringify(p);
                productSearchResults.appendChild(div);
            });
        },

        addProductToCart(e) {
            const productDiv = e.target.closest('[data-product]');
            if (!productDiv) return;

            try {
                const product = JSON.parse(productDiv.dataset.product);
                const existingItem = this.cart.find(item => item.id === product.id);
                if (existingItem) {
                    if (existingItem.quantity < existingItem.stock) {
                       existingItem.quantity++;
                    } else {
                       this.showNotification('وصلت للكمية القصوى في المخزون', 'warn');
                    }
                } else {
                    this.cart.push({ ...product, quantity: 1 });
                }
                this.renderCart();
                this.elements.productSearchInput.value = '';
                this.elements.productSearchResults.innerHTML = '';
            } catch (error) {
                console.error("Failed to parse product data", error);
                this.showNotification('خطأ في بيانات المنتج', 'error');
            }
        },

        handleCartClick(e) {
            const target = e.target.closest('.remove-item-btn, .quantity-btn');
            if (!target) return;
            
            const index = target.dataset.index;
            if (target.classList.contains('remove-item-btn')) {
                this.cart.splice(index, 1);
            } else if (target.classList.contains('quantity-plus')) {
                if(this.cart[index].quantity < this.cart[index].stock) {
                    this.cart[index].quantity++;
                } else {
                    this.showNotification('وصلت للكمية القصوى في المخزون', 'warn');
                }
            } else if (target.classList.contains('quantity-minus')) {
                if(this.cart[index].quantity > 1) {
                    this.cart[index].quantity--;
                }
            }
            this.renderCart();
        },

        setPaymentMethod(method) {
            this.paymentMethod = method;
            const { cashBtn, creditBtn, clientSearchArea, selectedClientDisplay } = this.elements;
            
            cashBtn.classList.toggle('active', method === 'CASH');
            creditBtn.classList.toggle('active', method === 'CREDIT');
            
            if (method === 'CREDIT') {
                clientSearchArea.style.display = 'block';
            } else {
                clientSearchArea.style.display = 'none';
                this.selectedClient = null;
                selectedClientDisplay.classList.add('hidden');
            }
            this.updateSubmitButtonState();
        },

        updateSubmitButtonState() {
            const { completeSaleBtn } = this.elements;
            const btnText = completeSaleBtn.querySelector('.btn-text');

            if (!this.paymentMethod) {
                btnText.textContent = 'اختر طريقة دفع أولاً';
                completeSaleBtn.disabled = true;
            } else if (this.cart.length === 0) {
                btnText.textContent = 'أضف منتجات للسلة';
                completeSaleBtn.disabled = true;
            } else if (this.paymentMethod === 'CREDIT' && !this.selectedClient) {
                btnText.textContent = 'اختر عميل للبيع بالدين';
                completeSaleBtn.disabled = true;
            } else {
                btnText.textContent = this.paymentMethod === 'CASH' ? 'إتمام البيع النقدي' : 'إتمام البيع بالدين';
                completeSaleBtn.disabled = false;
            }
        },
        
        async handleClientSearch(e) {
            const query = e.target.value;
            const { clientSearchResults } = this.elements;
            if (query.length < 1) { // تم التصحيح: يبدأ البحث من أول حرف
                clientSearchResults.innerHTML = '';
                clientSearchResults.style.display = 'none'; // إخفاء الحاوية
                return;
            }
            try {
                const response = await fetch(`/api/search-clients/?q=${encodeURIComponent(query)}`);
                const clients = await response.json();
                
                clientSearchResults.innerHTML = ''; // تم التصحيح: مسح النتائج القديمة أولاً
                
                if (clients.length > 0) {
                    clients.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b';
                        div.textContent = c.name;
                        div.dataset.client = JSON.stringify(c);
                        clientSearchResults.appendChild(div); // تم التصحيح: الإضافة مباشرة للحاوية
                    });
                } else {
                    const noResultDiv = document.createElement('div');
                    noResultDiv.className = 'p-3 text-center text-gray-500';
                    noResultDiv.textContent = 'لا توجد نتائج مطابقة';
                    clientSearchResults.appendChild(noResultDiv);
                }
                clientSearchResults.style.display = 'block'; // إظهار الحاوية
            } catch (error) {
                console.error('Client search failed:', error);
                clientSearchResults.style.display = 'none';
            }
        },

        selectClient(e) {
            const clientDiv = e.target.closest('[data-client]');
            if (!clientDiv) return;

            try {
                this.selectedClient = JSON.parse(clientDiv.dataset.client);
                const { selectedClientName, selectedClientDisplay, clientSearchInput, clientSearchResults } = this.elements;
                selectedClientName.textContent = this.selectedClient.name;
                selectedClientDisplay.classList.remove('hidden');
                clientSearchInput.value = '';
                clientSearchResults.innerHTML = '';
                clientSearchResults.style.display = 'none'; // تم التصحيح: إخفاء الحاوية بعد الاختيار
                this.updateSubmitButtonState();
            } catch (error) {
                console.error("Failed to parse client data", error);
            }
        },

        async submitSale() {
            if (this.apiInProcess) return;
            this.setLoading(true);

            const data = {
                cart: this.cart.map(item => ({ id: item.id, quantity: item.quantity, price: item.price })),
                payment_method: this.paymentMethod,
                client_id: this.selectedClient ? this.selectedClient.id : null,
            };
            
            try {
                const response = await fetch('/api/create-invoice/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'فشل في إنشاء الفاتورة');

                this.showNotification(result.message, 'success');
                this.cart = [];
                this.renderCart();
                this.setPaymentMethod(null);
            } catch (error) {
                this.showNotification(error.message, 'error');
            } finally {
                this.setLoading(false);
            }
        },

        // --- 5. Utility Functions ---
        setLoading(isLoading) {
            this.apiInProcess = isLoading;
            const btn = this.elements.completeSaleBtn;
            btn.disabled = isLoading;
            btn.querySelector('.btn-text').style.display = isLoading ? 'none' : 'inline';
            btn.querySelector('.btn-spinner').style.display = isLoading ? 'inline' : 'none';
        },
        
        showNotification(message, type = 'success') {
            const { toast, toastMessage } = this.elements;
            toastMessage.textContent = message;
            toast.className = 'p-4 rounded-lg shadow-lg text-white max-w-sm';
            if (type === 'error') toast.classList.add('bg-red-500');
            else if (type === 'warn') toast.classList.add('bg-yellow-500');
            else toast.classList.add('bg-green-500');
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        },

        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    };

    POS_APP.init();

});
</script>
{% endblock %}