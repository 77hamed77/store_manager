{% extends 'store/base.html' %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-500">

  <div class="max-w-7xl mx-auto px-6 py-10 space-y-10 animate-fade-in">

    <!-- ğŸ‘‹ Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
    <div>
      <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">ğŸ‘‹ ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±!</h1>
      <p class="text-gray-600 dark:text-gray-400">Ø¥Ù„ÙŠÙƒ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙŠÙˆÙ….</p>

      <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
      <div class="mt-8 grid grid-cols-2 sm:grid-cols-4 gap-6">
        <a href="{% url 'pos-view' %}"
           class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white flex flex-col items-center justify-center p-5 rounded-2xl shadow-lg hover:scale-105 transition-all">
          <svg class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span class="font-semibold text-sm sm:text-base">ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
        </a>

        <a href="{% url 'admin:store_product_add' %}" target="_blank"
           class="bg-gradient-to-r from-green-500 to-emerald-600 text-white flex flex-col items-center justify-center p-5 rounded-2xl shadow-lg hover:scale-105 transition-all">
          <svg class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="font-semibold text-sm sm:text-base">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</span>
        </a>

        <a href="{% url 'client-add' %}"
           class="bg-gradient-to-r from-sky-500 to-blue-600 text-white flex flex-col items-center justify-center p-5 rounded-2xl shadow-lg hover:scale-105 transition-all">
          <svg class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
          </svg>
          <span class="font-semibold text-sm sm:text-base">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</span>
        </a>

        <a href="{% url 'client-list' %}"
           class="bg-gradient-to-r from-rose-500 to-red-600 text-white flex flex-col items-center justify-center p-5 rounded-2xl shadow-lg hover:scale-105 transition-all">
          <svg class="h-8 w-8 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 7h6m0 0l-3-3m3 3l-3 7m-1-7l-3 3m3-3l-3 7m6-4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span class="font-semibold text-sm sm:text-base">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</span>
        </a>
      </div>
    </div>

    <!-- âœ… Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Ø§Ù„Ø¯ÙŠÙˆÙ† -->
      <a href="{% url 'client-list' %}"
         class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md border dark:border-gray-700 transition-all">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">ğŸ’° Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
        <div class="mt-4 flex justify-between items-baseline">
          <p class="text-4xl font-bold text-red-600 font-mono">{{ total_debt_sum|floatformat:2 }}</p>
          <p class="text-gray-500 dark:text-gray-400">Ø¹Ù„Ù‰ {{ top_debtors|length }} Ø¹Ù…Ù„Ø§Ø¡</p>
        </div>
      </a>

      <!-- Ø§Ù„Ù†ÙˆØ§Ù‚Øµ -->
      <a href="{% url 'low-stock-report' %}"
         class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md border dark:border-gray-700 transition-all">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">ğŸ“¦ Ù†ÙˆØ§Ù‚Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
        <div class="mt-4 flex justify-between items-baseline">
          <p class="text-4xl font-bold text-yellow-600 font-mono">{{ top_low_stock|length }}</p>
          <p class="text-gray-500 dark:text-gray-400">Ù…Ù†ØªØ¬Ø§Øª ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø·Ù„Ø¨</p>
        </div>
      </a>
    </div>

    <!-- âœ… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø·Ø· -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">

      <!-- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª --><div id="quick-notes" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
  <h3 class="font-bold text-lg mb-4 text-gray-700 dark:text-gray-100">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>

  <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† JavaScript (fallback) ÙˆÙŠØ¯Ø¹Ù…Ù‡ AJAX Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ -->
  <form id="note-form" method="POST" action="{% url 'dashboard' %}" class="mb-4">
    {% csrf_token %}
    <textarea id="note_content" name="note_content" rows="2"
      class="w-full p-3 border rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 mb-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none"
      placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©..." required></textarea>

    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <input type="checkbox" id="is_important" name="is_important" value="1"
          class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
        <label for="is_important" class="text-sm text-gray-700 dark:text-gray-300">Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©</label>
      </div>

      <div class="flex items-center gap-2">
        <button id="note-submit" type="submit"
          class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-all">Ø¥Ø¶Ø§ÙØ©</button>
        <span id="note-status" class="text-sm text-gray-500 dark:text-gray-400 hidden">...Ø­ÙØ¸</span>
      </div>
    </div>
  </form>

  <!-- Ø­Ø§ÙˆÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©) -->
  <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
    <h4 class="font-semibold mb-2 text-gray-700 dark:text-gray-300">Ø¢Ø®Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h4>
    <ul id="notes-list" class="space-y-2 text-sm">
      {% for note in recent_notes %}
      <li class="note-item p-2 rounded-md {% if note.is_important %}bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 font-semibold{% else %}bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300{% endif %}">
        {% if note.is_important %}â­ {% endif %}{{ note.content }}
      </li>
      {% empty %}
      <li id="no-notes" class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</li>
      {% endfor %}
    </ul>
  </div>
</div>

      <!-- âœ… Ø§Ù„Ù…Ø®Ø·Ø· -->
      <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border dark:border-gray-700">
        <h3 class="font-bold text-lg mb-4 text-gray-700 dark:text-gray-100">ğŸ“ˆ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠØ©</h3>
        <div class="relative w-full h-64">
          <canvas id="salesChart" class="absolute inset-0 w-full h-full"></canvas>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- âœ… Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("salesChart");
  if (!ctx) return;

  new Chart(ctx, {
    type: "line",
    data: {
      labels: ["11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"],
      datasets: [{
        label: "Contributions",
        data: [2, 0, 3, 0, 2, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 3, 2, 24, 2, 0, 2, 3, 0, 0, 0, 0, 0, 0, 0],
        borderColor: "#3B82F6",
        backgroundColor: "rgba(59,130,246,0.2)",
        borderWidth: 2,
        tension: 0.3,
        fill: true,
        pointBackgroundColor: "#fff",
        pointRadius: 4,
        pointHoverRadius: 5,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, /* âœ… ÙŠÙ…Ù†Ø¹ ØªÙ…Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø© */
      plugins: {
        legend: { display: false },
      },
      scales: {
        x: { title: { display: true, text: "Ø§Ù„Ø£ÙŠØ§Ù…" } },
        y: { title: { display: true, text: "Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" }, beginAtZero: true }
      }
    }
  });
});

/* Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ csrftoken Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ² (Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø·Ø±ÙŠÙ‚Ø© Django) */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

/* Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ AJAXØŒ Ù†Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙ†Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø®Ù„ÙÙŠØ© */
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('note-form');
  const textarea = document.getElementById('note_content');
  const importantCheckbox = document.getElementById('is_important');
  const submitBtn = document.getElementById('note-submit');
  const statusSpan = document.getElementById('note-status');
  const notesList = document.getElementById('notes-list');
  const noNotes = document.getElementById('no-notes');

  if (!form) return;

  form.addEventListener('submit', async (e) => {
    // Progressive enhancement: Ø¥Ø°Ø§ Ø¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù€ JS Ù…ÙØ¹Ù„ØŒ Ù†Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ ÙˆÙ†Ø³ØªØ®Ø¯Ù… fetch
    e.preventDefault();

    const content = textarea.value.trim();
    if (!content) {
      textarea.focus();
      return;
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø­ÙØ¸ Ù…Ø¤Ù‚ØªØ© ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-60', 'cursor-not-allowed');
    statusSpan.classList.remove('hidden');
    statusSpan.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ ÙŠÙ†ØªØ¸Ø±Ù‡Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const formData = new FormData();
    formData.append('note_content', content);
    // Ù†Ø¶ÙŠÙ is_important ÙƒÙ‚ÙŠÙ…Ø© '1' Ø£Ùˆ '' (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ÙƒÙŠÙ ÙŠØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±)
    if (importantCheckbox.checked) {
      formData.append('is_important', '1');
    }

    // Ø¥Ø¶Ø§ÙØ© csrf token
    const csrftoken = getCookie('csrftoken') || '';

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest',
          // Ù„Ø§ Ù†Ø¶Ø¹ 'Content-Type' Ù„Ø£Ù† Fetch Ø³ÙŠØ¶Ø¨Ø·Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù€ FormData
        },
      });

      if (!response.ok) {
        // ÙÙŠ Ø­Ø§Ù„ Ø£Ø¹Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø®Ø·Ø£ (Ù…Ø«Ù„Ø§Ù‹ 400 Ø£Ùˆ 500) Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø©
        const text = await response.text().catch(() => 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.');
        alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (text || response.statusText));
      } else {
        // Ù†Ø¬Ø±ÙŠ ØªØ­Ø¯ÙŠØ«Ù‹Ø§ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± JSON)
        // Ù†ÙÙ†Ø´Ø¦ Ø¹Ù†ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯ ÙŠØ¹ÙƒØ³ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
        const li = document.createElement('li');
        li.className = 'note-item p-2 rounded-md';
        if (importantCheckbox.checked) {
          li.classList.add('bg-red-50', 'dark:bg-red-900/30', 'text-red-700', 'dark:text-red-300', 'font-semibold');
          li.textContent = 'â­ ' + content;
        } else {
          li.classList.add('bg-gray-50', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
          li.textContent = content;
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª" Ù†Ø­Ø°ÙÙ‡Ø§
        if (noNotes) {
          noNotes.remove();
        }

        // Ø£Ø¶Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        if (notesList.firstChild) {
          notesList.insertBefore(li, notesList.firstChild);
        } else {
          notesList.appendChild(li);
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ§Ù„ÙŠ
        textarea.value = '';
        importantCheckbox.checked = false;
      }
    } catch (err) {
      console.error(err);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
      statusSpan.classList.add('hidden');
    }
  });
});
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.6s ease-in-out both;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}
