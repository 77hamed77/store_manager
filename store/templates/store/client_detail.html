{% extends 'store/base.html' %}

{% block title %}تفاصيل العميل: {{ client.name }}{% endblock %}

{% block content %}
<!-- 1. رأس الصفحة: معلومات العميل والإجراءات الرئيسية -->
<div class="bg-white p-4 rounded-lg shadow-md mb-6">
    <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ client.name }}</h1>
            {% if client.phone %}
            <div class="flex items-center gap-2 mt-2 text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                <span>{{ client.phone }}</span>
            </div>
            {% endif %}
        </div>
        <div class="flex items-center gap-3">
            <a href="https://wa.me/{{ client.phone }}" target="_blank" class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.001,0C4.486,0,0,4.486,0,10.001c0,5.515,4.486,10,10.001,10c5.514,0,10-4.485,10-10C20,4.486,15.515,0,10.001,0z M14.162,12.787c-0.121-0.24-0.849-0.985-0.985-1.12c-0.137-0.137-0.303-0.198-0.53-0.076c-0.227,0.121-0.79,0.79-0.926,0.926c-0.137,0.137-0.24,0.165-0.438-0.033c-0.198-0.198-0.849-0.644-1.62-1.387c-0.595-0.595-1-1.25-1.12-1.48c-0.121-0.227-0.01-0.33,0.093-0.424c0.104-0.093,0.227-0.227,0.33-0.33c0.104-0.104,0.137-0.198,0.198-0.33c0.061-0.137,0.033-0.273-0.033-0.395c-0.065-0.121-0.595-1.419-0.812-1.949c-0.217-0.53-0.424-0.469-0.595-0.469c-0.165,0-0.33,0-0.53,0c-0.198,0-0.53,0.065-0.79,0.33c-0.26,0.26-0.985,0.954-0.985,2.372c0,1.418,1.018,2.76,1.154,2.958c0.137,0.198,1.98,3.159,4.84,4.24c2.86,1.081,2.86,0.725,3.36,0.66c0.5-0.065,1.581-0.659,1.81-1.282c0.227-0.623,0.227-1.154,0.165-1.282C14.465,12.985,14.283,12.91,14.162,12.787z"></path></svg>
                <span>واتساب</span>
            </a>
            <button onclick="window.print()" class="flex items-center gap-2 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clip-rule="evenodd"></path></svg>
                <span>طباعة الكشف</span>
            </button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 2. كشف الحساب الاحترافي (الجزء الأكبر) -->
    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4">كشف حساب العميل</h2>
        <div class="overflow-y-auto max-h-[600px] border rounded-lg">
            <table class="min-w-full">
                <thead class="bg-gray-200 sticky top-0">
                    <tr>
                        <th class="py-3 px-4 text-right text-sm font-semibold text-gray-600">التاريخ</th>
                        <th class="py-3 px-4 text-right text-sm font-semibold text-gray-600">البيان</th>
                        <th class="py-3 px-4 text-right text-sm font-semibold text-gray-600">المبلغ</th>
                        <th class="py-3 px-4 text-right text-sm font-semibold text-gray-600">الرصيد بعد الحركة</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for tx in transactions_with_balance %}
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 text-gray-600 font-mono text-sm">{{ tx.date|date:"Y-m-d" }}</td>
                        <td class="p-4">
                            {% if tx.type == 'invoice' %}
                                <div class="flex items-center gap-2">
                                    <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-red-100 text-red-600 rounded-full">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5 1.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path></svg>
                                    </span>
                                    <span class="font-semibold">{{ tx.description }}</span>
                                </div>
                            {% else %}
                                <div class="flex items-center gap-2">
                                    <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-green-100 text-green-600 rounded-full">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    </span>
                                    <span class="font-semibold text-green-700">{{ tx.description }}</span>
                                </div>
                            {% endif %}
                        </td>
                        <td class="p-4 font-mono">
                            {% if tx.type == 'invoice' %}
                                <span class="text-red-600 font-bold">-{{ tx.amount|floatformat:2 }}</span>
                            {% else %}
                                <span class="text-green-600 font-bold">+{{ tx.amount|floatformat:2 }}</span>
                            {% endif %}
                        </td>
                        <td class="p-4 font-mono font-semibold text-gray-800">{{ tx.balance_after|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center py-8 text-gray-500">لا توجد دفعات لعرضها.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- 3. بطاقة تسجيل الدفعة المحسّنة (الجزء الأصغر واللاصق) -->
    <div class="lg:col-span-1 h-fit sticky top-4">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="bg-red-100 border-r-4 border-red-500 text-red-700 p-4 rounded-lg mb-6">
                <p class="font-bold">إجمالي الدين الحالي</p>
                <p id="total-debt-display" class="text-3xl font-mono">{{ client.total_debt|floatformat:2 }}</p>
            </div>
            
            <h3 class="text-lg font-bold mb-4 border-t pt-4">تسجيل دفعة جديدة</h3>
            <form action="{% url 'record-payment' client.id %}" method="POST">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="amount" class="block mb-2 font-medium">المبلغ المدفوع</label>
                    <input type="number" step="0.01" min="0.01" max="{{ client.total_debt|floatformat:2 }}" name="amount" id="amount-input" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="text-center mb-4">
                     <button type="button" id="pay-full-btn" class="text-sm text-blue-600 hover:underline">تسديد المبلغ كاملاً</button>
                </div>
                <div class="mb-4">
                    <label for="notes" class="block mb-2 font-medium">ملاحظات (اختياري)</label>
                    <textarea name="notes" id="notes" rows="2" class="w-full p-2 border rounded-lg"></textarea>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    <span>تسجيل الدفعة</span>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const payFullBtn = document.getElementById('pay-full-btn');
    const amountInput = document.getElementById('amount-input');
    const totalDebtDisplay = document.getElementById('total-debt-display');

    if (payFullBtn && amountInput && totalDebtDisplay) {
        // استبدال الفاصلة (,) بنقطة (.) إذا كانت موجودة لضمان عمل parseFloat بشكل صحيح
        const totalDebt = parseFloat(totalDebtDisplay.textContent.replace(',', '.'));
        
        payFullBtn.addEventListener('click', () => {
            if (!isNaN(totalDebt)) {
                amountInput.value = totalDebt.toFixed(2);
            }
        });
    }
});
</script>
{% endblock %}